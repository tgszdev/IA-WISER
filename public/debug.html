<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Teste de Conexão Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-xl">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">
                <i class="fas fa-bug mr-2"></i>Debug - Teste de Conexão
            </h1>
            <p class="text-gray-400">Página para testar a conexão com Supabase e APIs</p>
        </div>

        <!-- Status Cards -->
        <div class="grid md:grid-cols-3 gap-4 mb-6">
            <!-- Supabase Status -->
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-gray-300">Supabase</h3>
                    <span id="supabase-status" class="px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-400">
                        <i class="fas fa-circle mr-1"></i>Não testado
                    </span>
                </div>
                <div class="text-xs text-gray-500">
                    <div>URL: <span id="supabase-url" class="text-gray-400">-</span></div>
                    <div>Anon Key: <span id="supabase-key" class="text-gray-400">-</span></div>
                </div>
            </div>

            <!-- Google AI Status -->
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-gray-300">Google AI</h3>
                    <span id="google-status" class="px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-400">
                        <i class="fas fa-circle mr-1"></i>Não testado
                    </span>
                </div>
                <div class="text-xs text-gray-500">
                    <div>API Key: <span id="google-key" class="text-gray-400">-</span></div>
                    <div>Modelo: <span class="text-gray-400">gemini-1.5-flash</span></div>
                </div>
            </div>

            <!-- Database Status -->
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-gray-300">Banco de Dados</h3>
                    <span id="db-status" class="px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-400">
                        <i class="fas fa-circle mr-1"></i>Não conectado
                    </span>
                </div>
                <div class="text-xs text-gray-500">
                    <div>Tabela: <span class="text-gray-400">estoque</span></div>
                    <div>Registros: <span id="db-count" class="text-gray-400">-</span></div>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-xl">
            <h2 class="text-xl font-bold text-gray-300 mb-4">
                <i class="fas fa-flask mr-2"></i>Testes de Conexão
            </h2>
            
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Test Buttons -->
                <div class="space-y-3">
                    <button onclick="testSupabaseConnection()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-database mr-2"></i>Testar Conexão Supabase
                    </button>
                    
                    <button onclick="testChatAPI()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-comments mr-2"></i>Testar API do Chat
                    </button>
                    
                    <button onclick="testGoogleAI()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-robot mr-2"></i>Testar Google AI
                    </button>
                    
                    <button onclick="runAllTests()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-play-circle mr-2"></i>Executar Todos os Testes
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-3">
                    <button onclick="fetchInventoryData()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-boxes mr-2"></i>Buscar Dados do Estoque
                    </button>
                    
                    <button onclick="clearLogs()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-eraser mr-2"></i>Limpar Logs
                    </button>
                    
                    <button onclick="exportLogs()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-download mr-2"></i>Exportar Logs
                    </button>
                    
                    <button onclick="location.reload()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-sync mr-2"></i>Recarregar Página
                    </button>
                </div>
            </div>
        </div>

        <!-- Log Output -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-300">
                    <i class="fas fa-terminal mr-2"></i>Console de Debug
                </h2>
                <span id="log-count" class="text-xs text-gray-500">0 logs</span>
            </div>
            
            <div id="log-output" class="bg-black rounded p-4 h-96 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Aguardando comandos...</div>
            </div>
        </div>

        <!-- Environment Variables Info -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6 shadow-xl">
            <h2 class="text-xl font-bold text-gray-300 mb-4">
                <i class="fas fa-key mr-2"></i>Variáveis de Ambiente Necessárias
            </h2>
            
            <div class="bg-gray-900 rounded p-4 font-mono text-sm">
                <div class="text-green-400 mb-2"># Adicione no Vercel:</div>
                <div class="text-gray-300">NEXT_PUBLIC_SUPABASE_URL=<span class="text-blue-400">https://tecvgnrqcfqcrcodrjtt.supabase.co</span></div>
                <div class="text-gray-300">NEXT_PUBLIC_SUPABASE_ANON_KEY=<span class="text-blue-400">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</span></div>
                <div class="text-gray-300">GOOGLE_API_KEY=<span class="text-yellow-400">[sua_google_api_key]</span></div>
            </div>
        </div>
    </div>

    <script>
        // Log management
        let logCount = 0;
        const logOutput = document.getElementById('log-output');
        const logCountElement = document.getElementById('log-count');

        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                debug: 'text-gray-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} mb-1`;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            if (logOutput.firstChild?.className === 'text-gray-500') {
                logOutput.innerHTML = '';
            }
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            logCountElement.textContent = `${logCount} logs`;
        }

        function clearLogs() {
            logOutput.innerHTML = '<div class="text-gray-500">Logs limpos. Aguardando comandos...</div>';
            logCount = 0;
            logCountElement.textContent = '0 logs';
        }

        function exportLogs() {
            const logs = logOutput.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-logs-${new Date().toISOString()}.txt`;
            a.click();
            log('Logs exportados com sucesso', 'success');
        }

        // Update status indicators
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClasses = {
                success: 'bg-green-600 text-white',
                error: 'bg-red-600 text-white',
                warning: 'bg-yellow-600 text-black',
                loading: 'bg-blue-600 text-white',
                default: 'bg-gray-700 text-gray-400'
            };
            
            element.className = `px-2 py-1 rounded text-xs font-bold ${statusClasses[status]}`;
            element.innerHTML = `<i class="fas fa-circle mr-1"></i>${message}`;
        }

        // Test Supabase Connection
        async function testSupabaseConnection() {
            log('🔍 Iniciando teste de conexão Supabase...', 'info');
            updateStatus('supabase-status', 'loading', 'Testando...');
            
            try {
                // First check if we have the required environment variables
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'supabase' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ Conexão Supabase OK! ${data.recordCount || 0} registros encontrados`, 'success');
                    updateStatus('supabase-status', 'success', 'Conectado');
                    updateStatus('db-status', 'success', 'Online');
                    document.getElementById('db-count').textContent = data.recordCount || '0';
                    document.getElementById('supabase-url').textContent = 'Configurado';
                    document.getElementById('supabase-key').textContent = 'Configurado';
                } else {
                    log(`❌ Erro Supabase: ${data.error}`, 'error');
                    updateStatus('supabase-status', 'error', 'Erro');
                    
                    if (data.error.includes('NEXT_PUBLIC_SUPABASE_ANON_KEY')) {
                        log('⚠️ Variável NEXT_PUBLIC_SUPABASE_ANON_KEY não configurada no Vercel', 'warning');
                    }
                }
            } catch (error) {
                log(`❌ Erro ao testar Supabase: ${error.message}`, 'error');
                updateStatus('supabase-status', 'error', 'Falhou');
            }
        }

        // Test Chat API
        async function testChatAPI() {
            log('🔍 Testando API do Chat...', 'info');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'Teste de conexão' })
                });
                
                const data = await response.json();
                
                if (data.response) {
                    log('✅ API do Chat funcionando!', 'success');
                    log(`Resposta: ${data.response.substring(0, 100)}...`, 'debug');
                    
                    if (data.estoqueLoaded) {
                        log(`✅ Estoque carregado: ${data.totalProdutos} produtos`, 'success');
                    } else {
                        log('⚠️ Estoque não foi carregado', 'warning');
                    }
                } else if (data.error) {
                    log(`❌ Erro na API: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Erro ao testar Chat API: ${error.message}`, 'error');
            }
        }

        // Test Google AI
        async function testGoogleAI() {
            log('🔍 Testando Google AI...', 'info');
            updateStatus('google-status', 'loading', 'Testando...');
            
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'google' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('✅ Google AI configurado e funcionando!', 'success');
                    updateStatus('google-status', 'success', 'Conectado');
                    document.getElementById('google-key').textContent = 'Configurado';
                } else {
                    log(`❌ Google AI não configurado: ${data.error}`, 'error');
                    updateStatus('google-status', 'error', 'Não configurado');
                    
                    if (data.error.includes('GOOGLE_API_KEY')) {
                        log('⚠️ Configure GOOGLE_API_KEY no Vercel', 'warning');
                    }
                }
            } catch (error) {
                log(`❌ Erro ao testar Google AI: ${error.message}`, 'error');
                updateStatus('google-status', 'error', 'Falhou');
            }
        }

        // Fetch inventory data
        async function fetchInventoryData() {
            log('📦 Buscando dados do estoque...', 'info');
            
            try {
                const response = await fetch('/api/inventory', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success && data.products) {
                    log(`✅ ${data.products.length} produtos encontrados no estoque`, 'success');
                    
                    // Show first 5 products
                    data.products.slice(0, 5).forEach(product => {
                        log(`📦 ${product.codigo_produto} - ${product.descricao_produto} (${product.saldo_disponivel_produto} unidades)`, 'debug');
                    });
                    
                    if (data.products.length > 5) {
                        log(`... e mais ${data.products.length - 5} produtos`, 'debug');
                    }
                } else {
                    log(`❌ Erro ao buscar estoque: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Erro ao buscar dados: ${error.message}`, 'error');
            }
        }

        // Run all tests
        async function runAllTests() {
            log('🚀 Executando todos os testes...', 'info');
            log('=' .repeat(50), 'debug');
            
            await testSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGoogleAI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testChatAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await fetchInventoryData();
            
            log('=' .repeat(50), 'debug');
            log('✅ Todos os testes concluídos!', 'success');
        }

        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            log('🎯 Página de debug carregada', 'info');
            log('URL do site: ' + window.location.href, 'debug');
            log('Clique nos botões acima para testar as conexões', 'info');
        });
    </script>
</body>
</html>